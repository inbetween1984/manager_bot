<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <title>Форма сделки</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    body { padding: 20px; }
    .block { border: 1px solid #dee2e6; border-radius: 5px; padding: 15px; margin-bottom: 15px; background: #f8f9fa; }
    .service { border-left: 3px solid #0d6efd; margin: 10px 0; padding-left: 10px; }
    .totals p { margin: 0; }
  </style>
</head>
<body>
  <div class="container">
    <h2 class="mb-4">Форма сделки</h2>

    <div class="mb-3">
      <label class="form-label">Менеджер:</label>
      <select id="manager" class="form-select" required>
        <option value="">-- загружается... --</option>
      </select>
    </div>

    <div class="mb-3">
      <label class="form-label">Тип клиента:</label>
      <select id="clientType" class="form-select" onchange="toggleClientFields()" required>
        <option value="">-- выберите --</option>
        <option value="ФЛ">ФЛ</option>
        <option value="ЮЛ">ЮЛ</option>
        <option value="МП">МП</option>
      </select>
    </div>

    <div id="clientFields" class="block">
      <div class="mb-3">
        <label class="form-label">ФИО клиента:</label>
        <input type="text" id="clientName" class="form-control" required>
      </div>
      <div class="mb-3" id="phoneField">
        <label class="form-label">Телефон:</label>
        <input type="text" id="clientPhone" class="form-control" required>
      </div>
      <div id="extraFields"></div>
    </div>

    <h4>Товары</h4>
    <div id="products"></div>
    <button type="button" class="btn btn-primary btn-sm mb-3" onclick="addProduct()">+ Добавить товар</button>

    <div class="totals alert alert-info">
      <p>Сумма за товары: <span id="totalProducts">0</span></p>
      <p>Сумма за услуги: <span id="totalServices">0</span></p>
      <p>Общая сумма сделки: <span id="grandTotal">0</span></p>
    </div>

    <h4>Финансы</h4>
    <div class="mb-3">
      <label class="form-label">Сумма, поступившая на счёт:</label>
      <input type="number" id="accountAmount" class="form-control" value="0" required>
    </div>
    <div class="mb-3">
      <label class="form-label">Счёт:</label>
      <select id="account" class="form-select" required>
        <option value="">-- загружается... --</option>
      </select>
    </div>

    <h4>Склад</h4>
    <div class="mb-3">
      <label class="form-label">Наличие:</label>
      <select id="stockStatus" class="form-select" onchange="toggleStockFields()" required>
        <option value="">-- выберите --</option>
        <option value="Есть">Есть</option>
        <option value="Нет">Нет</option>
      </select>
    </div>
    <div id="stockExtra"></div>

    <h4>Файлы</h4>
    <div class="mb-3">
      <label class="form-label">Калькулятор:</label>
      <input type="file" id="calculator" class="form-control" required>
    </div>
    <div class="mb-3">
      <label class="form-label">Платёжное поручение / Чек / Фото:</label>
      <input type="file" id="paymentFile" class="form-control" required>
    </div>

    <button type="button" class="btn btn-success mb-3" onclick="submitForm()">Отправить</button>
  </div>

<script>
  const tg = window.Telegram.WebApp;
  tg.ready();
  tg.expand();

  API_BASE = "https://4ab1b24b-2fae-4dc5-b091-63c08ebb5152.tunnel4.com"
async function loadOptions(endpoint, selectId, placeholder="-- выберите --") {
  try {
    let response = await fetch(endpoint);
    if (!response.ok) throw new Error("Ошибка загрузки: " + response.status);
    let data = await response.json();

    let select = document.getElementById(selectId);
    select.innerHTML = `<option value="">${placeholder}</option>`;
    data.forEach(item => {
      let opt = document.createElement("option");
      opt.value = item.name;
      opt.textContent = item.name;
      select.appendChild(opt);
    });
  } catch (err) {
    console.error("Ошибка:", err);
    let select = document.getElementById(selectId);
    select.innerHTML = `<option value="">-- ошибка загрузки --</option>`;
  }
}

document.addEventListener("DOMContentLoaded", () => {
  loadOptions(`${API_BASE}/api/managers`, "manager");
  loadOptions(`${API_BASE}/api/accounts`, "account");
});

function toggleClientFields() {
  let type = document.getElementById("clientType").value;
  let phoneField = document.getElementById("phoneField");
  let extra = document.getElementById("extraFields");
  extra.innerHTML = "";

  if (type === "ЮЛ") {
    phoneField.style.display = "block";
    document.getElementById("clientPhone").required = true;
    extra.innerHTML = `
      <div class="mb-3">
        <label class="form-label">Компания:</label>
        <input type="text" id="company" class="form-control" required>
      </div>
      <div class="mb-3">
        <label class="form-label">ИНН:</label>
        <input type="text" id="inn" class="form-control" required>
      </div>`;
  } else if (type === "МП") {
    phoneField.style.display = "none";
    document.getElementById("clientPhone").required = false;
    extra.innerHTML = `
      <div class="mb-3">
        <label class="form-label">Номер заказа:</label>
        <input type="text" id="orderNumber" class="form-control" required>
      </div>`;
  } else {
    phoneField.style.display = "block";
    document.getElementById("clientPhone").required = true;
  }
}

function addProduct() {
  let productsDiv = document.getElementById("products");
  let productBlock = document.createElement("div");
  productBlock.className = "block product";
  productBlock.innerHTML = `
    <div class="mb-3">
      <label class="form-label">Наименование товара:</label>
      <input type="text" class="form-control productName" required>
    </div>
    <div class="mb-3">
      <label class="form-label">Сумма за товар:</label>
      <input type="number" class="form-control productPrice" value="0" required oninput="recalculateTotals()">
    </div>
    <div class="services"></div>
    <button type="button" class="btn btn-outline-primary btn-sm" onclick="addService(this)">+ Добавить услугу</button>
  `;
  productsDiv.appendChild(productBlock);
  recalculateTotals();
}

function addService(button) {
  let servicesDiv = button.previousElementSibling;
  let service = document.createElement("div");
  service.className = "service";
  service.innerHTML = `
    <div class="mb-3">
      <label class="form-label">Услуга:</label>
      <select class="form-select serviceName" required>
        <option value="Гравировка">Гравировка</option>
        <option value="ОС">Установка ОС</option>
        <option value="Замена комплектующих">Замена комплектующих</option>
      </select>
    </div>
    <div class="mb-3">
      <label class="form-label">Цена услуги:</label>
      <input type="number" class="form-control servicePrice" value="0" required oninput="recalculateTotals()">
    </div>
  `;
  servicesDiv.appendChild(service);
  recalculateTotals();
}

function toggleStockFields() {
  let status = document.getElementById("stockStatus").value;
  let extra = document.getElementById("stockExtra");
  extra.innerHTML = "";

  if (status === "Есть") {
    extra.innerHTML = `
      <div class="mb-3">
        <label class="form-label">Номер сделки:</label>
        <input type="text" id="dealNumber" class="form-control" required>
      </div>`;
  } else if (status === "Нет") {
    extra.innerHTML = `
      <div class="mb-3">
        <label class="form-label">Заказать у:</label>
        <select id="supplier" class="form-select" required>
          <option value="">-- загружается... --</option>
        </select>
      </div>`;
    loadOptions(`${API_BASE}/api/suppliers`, "supplier");
  }
}

function recalculateTotals() {
  let products = document.querySelectorAll(".product");
  let totalProducts = 0;
  let totalServices = 0;

  products.forEach(p => {
    let pprice = +p.querySelector(".productPrice").value || 0;
    totalProducts += pprice;
    let services = p.querySelectorAll(".service");
    services.forEach(s => {
      totalServices += +s.querySelector(".servicePrice").value || 0;
    });
  });

  let grand = totalProducts + totalServices;
  document.getElementById("totalProducts").innerText = totalProducts;
  document.getElementById("totalServices").innerText = totalServices;
  document.getElementById("grandTotal").innerText = grand;
}

async function submitForm() {
  let manager = document.getElementById("manager").value;
  let clientType = document.getElementById("clientType").value;
  let name = document.getElementById("clientName").value;
  let phone = document.getElementById("clientPhone").value;

  let clientExtra = {};
  if (clientType === "ЮЛ") {
    clientExtra = { company: document.getElementById("company").value, inn: document.getElementById("inn").value };
  } else if (clientType === "МП") {
    clientExtra = { orderNumber: document.getElementById("orderNumber").value };
  }

  let products = [];
  document.querySelectorAll(".product").forEach(p => {
    let pname = p.querySelector(".productName").value;
    let pprice = +p.querySelector(".productPrice").value;
    let services = [];
    p.querySelectorAll(".service").forEach(s => {
      services.push({
        name: s.querySelector(".serviceName").value,
        price: +s.querySelector(".servicePrice").value
      });
    });
    products.push({ name: pname, price: pprice, services: services });
  });

  let accountAmount = document.getElementById("accountAmount").value;
  let account = document.getElementById("account").value;

  let stockStatus = document.getElementById("stockStatus").value;
  let stockExtra = {};
  if (stockStatus === "Есть") {
    stockExtra = { dealNumber: document.getElementById("dealNumber").value };
  } else if (stockStatus === "Нет") {
    stockExtra = { supplier: document.getElementById("supplier").value };
  }

  let totalProducts = document.getElementById("totalProducts").innerText;
  let totalServices = document.getElementById("totalServices").innerText;
  let grandTotal = document.getElementById("grandTotal").innerText;

  let payload = {
    manager,
    clientType,
    client: { name, phone, ...clientExtra },
    products,
    totals: { products: totalProducts, services: totalServices, grand: grandTotal },
    finance: { accountAmount, account },
    stock: { status: stockStatus, ...stockExtra },
    chat_id: tg.initDataUnsafe?.user?.id || null
  };

  const formData = new FormData();
  formData.append('sale', JSON.stringify(payload));
  formData.append('calculator', document.getElementById("calculator").files[0]);
  formData.append('paymentFile', document.getElementById("paymentFile").files[0]);

  try {
    let response = await fetch(`${API_BASE}/api/submit`, {
      method: "POST",
      body: formData
    });

    if (!response.ok) throw new Error("Ошибка при отправке: " + response.status);
    alert("Данные успешно отправлены!");
  } catch (err) {
    console.error(err);
    alert("Ошибка: " + err.message);
  }
}
</script>
</body>
</html>
